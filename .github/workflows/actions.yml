name: Package Flutter Run
on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main

jobs:
  build:
    # This job will run on ubuntu virtual machine
    if: github.ref != 'refs/heads/stable'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
            
      - uses: actions/setup-java@v1
        with:
          java-version: "12.x"

      - uses: subosito/flutter-action@v1
        with:
          channel: "stable"

      - run: flutter pub get

      - run: dart format --set-exit-if-changed .

      - run: flutter analyze .

      - run: flutter test

      # Install pana
      - name: Install pana
        run: pub global activate pana

      # Run pana to generate the package score report
      - name: Run pana
        run: pub global run pana

      # Extract score from pana report
      - name: Extract pana score
        id: extract-pana-score
        run: |
          score=$(grep -oP "(?<=score: )\d+\.\d+" pana_report.txt)
          echo "::set-output name=pana-score::$score"

      # Use the extracted score as an output
      - name: Use pana score
        run: echo "Pana Score: ${{ steps.extract-pana-score.outputs.pana-score }}"

      # Pub dry run
      - run: flutter pub publish --dry-run
